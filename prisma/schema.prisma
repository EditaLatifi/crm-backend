model Attachment {
  id        String   @id @default(uuid())
  dealId    String
  deal      Deal     @relation(fields: [dealId], references: [id])
  url       String
  filename  String
  uploadedByUserId String
  uploadedBy User   @relation("uploadedBy", fields: [uploadedByUserId], references: [id])
  createdAt DateTime @default(now())
}

model Note {
  id        String   @id @default(uuid())
  dealId    String
  deal      Deal     @relation(fields: [dealId], references: [id])
  content   String
  createdByUserId String
  createdBy User   @relation("createdBy", fields: [createdByUserId], references: [id])
  createdAt DateTime @default(now())
}
model Comment {
  id        String   @id @default(uuid())
  taskId    String
  task      Task     @relation("TaskComments", fields: [taskId], references: [id], onDelete: Cascade)
  authorId  String
  author    User     @relation("UserComments", fields: [authorId], references: [id])
  text      String
  createdAt DateTime @default(now())
}

model TaskHistory {
  id        String   @id @default(uuid())
  taskId    String
  task      Task     @relation("TaskHistory", fields: [taskId], references: [id], onDelete: Cascade)
  action    String
  payload   Json?
  createdAt DateTime @default(now())
  userId    String
  user      User     @relation("UserTaskHistory", fields: [userId], references: [id])
}
// This is the main Prisma schema for the CRM system
// It covers all required entities and relationships

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id           String   @id @default(uuid())
  email        String   @unique
  passwordHash String
  name         String
  role         Role
  createdAt    DateTime @default(now())
  accounts     Account[] @relation("AccountOwner")
  createdAccounts Account[] @relation("AccountCreator")
  deals        Deal[]    @relation("DealOwner")
  createdDeals Deal[]    @relation("DealCreator")
  assignedTasks Task[]   @relation("TaskAssignee")
  createdTasks Task[]    @relation("TaskCreator")
  timeEntries  TimeEntry[]
  runningTimer RunningTimer?
  activities   Activity[] @relation("ActivityActor")
  dailyTimeByUser DailyTimeByUser[]
  dealStageHistories DealStageHistory[]
  comments     Comment[] @relation("UserComments")
  taskHistory  TaskHistory[] @relation("UserTaskHistory")
  uploadedAttachments Attachment[] @relation("uploadedBy")
  createdNotes Note[] @relation("createdBy")
}

enum Role {
  ADMIN
  USER
}

model Account {
  id             String    @id @default(uuid())
  name           String
  type           AccountType
  address        String?
  phone          String?
  email          String?
  notes          String?
  ownerUserId    String?
  owner          User?     @relation("AccountOwner", fields: [ownerUserId], references: [id])
  createdByUserId String
  creator        User      @relation("AccountCreator", fields: [createdByUserId], references: [id])
  contacts       Contact[]
  deals          Deal[]
  tasks          Task[]
  timeEntries    TimeEntry[]
  runningTimers  RunningTimer[]
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  dailyTimeByAccount DailyTimeByAccount[]
}

enum AccountType {
  CLIENT
  POTENTIAL_CLIENT
  PARTNER
}

model Contact {
  id        String   @id @default(uuid())
  accountId String?
  account   Account?  @relation(fields: [accountId], references: [id])
  name      String
  email     String
  phone     String?
  title     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  tasks      Task[]
}

model DealStage {
  id      String  @id @default(uuid())
  name    String
  order   Int
  isWon   Boolean @default(false)
  isLost  Boolean @default(false)
    deals   Deal[]
    histories DealStageHistory[] @relation("ToStage")
    fromHistories DealStageHistory[] @relation("FromStage")
}

model Deal {
  id             String   @id @default(uuid())
  accountId      String
  account        Account  @relation(fields: [accountId], references: [id])
  name           String
  stageId        String
  stage          DealStage @relation(fields: [stageId], references: [id])
  amount         Float
  currency       String
  probability    Int      // Probability to win (0-100)
  dealScore      Int      @default(0) // Calculated score for the deal
  expectedCloseDate DateTime
  customFields   Json? // Flexible custom fields per deal
  ownerUserId    String?
  owner          User?    @relation("DealOwner", fields: [ownerUserId], references: [id])
  createdByUserId String
  creator        User     @relation("DealCreator", fields: [createdByUserId], references: [id])
  tasks          Task[]
  attachments    Attachment[]
  notes          Note[]
  stageHistories DealStageHistory[]
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  @@index([stageId])
  @@index([accountId])
}

model DealStageHistory {
  id            String   @id @default(uuid())
  dealId        String
  deal          Deal     @relation(fields: [dealId], references: [id])
  fromStageId   String?
  toStageId     String
  toStage       DealStage  @relation("ToStage", fields: [toStageId], references: [id])
  fromStage     DealStage? @relation("FromStage", fields: [fromStageId], references: [id])
  changedByUserId String
  changedBy     User      @relation(fields: [changedByUserId], references: [id])
  changedAt     DateTime  @default(now())
}

model Task {
  id              String   @id @default(uuid())
  title           String
  description     String?
  status          TaskStatus
  priority        TaskPriority
  dueDate         DateTime?
  assignedToUserId String?
  assignee        User?    @relation("TaskAssignee", fields: [assignedToUserId], references: [id])
  createdByUserId String
  creator         User     @relation("TaskCreator", fields: [createdByUserId], references: [id])
  accountId       String?
  account         Account? @relation(fields: [accountId], references: [id])
  contactId       String?
  contact         Contact? @relation(fields: [contactId], references: [id])
  // already has activities and dailyTimeByTask
  dealId          String?
  deal            Deal?    @relation(fields: [dealId], references: [id])
  timeEntries     TimeEntry[]
  runningTimers   RunningTimer[]
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  dailyTimeByTask DailyTimeByTask[]
  comments        Comment[] @relation("TaskComments")
  history         TaskHistory[] @relation("TaskHistory")
  estimate  Int?
}

enum TaskStatus {
  OPEN
  IN_PROGRESS
  DONE
}

enum TaskPriority {
  LOW
  MEDIUM
  HIGH
}

model TimeEntry {
  id          String   @id @default(uuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id])
  accountId   String
  account     Account  @relation(fields: [accountId], references: [id])
  taskId      String?
  task        Task?    @relation(fields: [taskId], references: [id])
  startedAt   DateTime
  endedAt     DateTime
  durationMinutes Int
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  @@index([userId, startedAt])
  @@index([accountId, startedAt])
}

model RunningTimer {
  id          String   @id @default(uuid())
  userId      String   @unique
  user        User     @relation(fields: [userId], references: [id])
  accountId   String
  account     Account  @relation(fields: [accountId], references: [id])
  taskId      String?
  task        Task?    @relation(fields: [taskId], references: [id])
  startedAt   DateTime
  description String?
}

model Activity {
  id          String   @id @default(uuid())
  actorUserId String
  actor       User     @relation("ActivityActor", fields: [actorUserId], references: [id])
  entityType  String
  entityId    String
  action      String
  payloadJson Json
  createdAt   DateTime @default(now())
  // Relations for filtering
    // No foreign keys for entityId (polymorphic reference)
  @@index([entityType, entityId])
  @@index([createdAt])
}

// Optional: Daily Aggregates
model DailyTimeByUser {
  date      DateTime
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  totalMinutes Int
  @@id([date, userId])
}

model DailyTimeByAccount {
  date      DateTime
  accountId String
  account   Account  @relation(fields: [accountId], references: [id])
  totalMinutes Int
  @@id([date, accountId])
}

model DailyTimeByTask {
  date      DateTime
  taskId    String
  task      Task     @relation(fields: [taskId], references: [id])
  totalMinutes Int
  @@id([date, taskId])
}

